# Design 1

## Requirements

修复agent项目运行时输入信息后一直转圈没有响应的问题。

**问题现象**：
- 用户在LangGraph Studio界面输入消息后，系统一直显示转圈状态
- 没有任何响应或错误提示
- 界面卡死，无法继续使用

**根本原因分析**：
1. **模块导入问题**：项目未正确安装，导致`react_agent`模块无法导入 ✓已解决
2. **MCP服务器连接超时**：工具初始化时连接外部MCP服务器（Twitter MCP和Remote MCP）出现超时，导致整个工具加载过程hang住
3. **缺乏超时处理机制**：`_get_all_mcp_tools()`函数虽然有异常捕获，但缺乏有效的超时控制

**影响范围**：
- 所有需要使用工具的对话都会卡住
- 基本的搜索功能也受影响
- 整个agent系统无法正常工作

## Solution

### 核心策略：快速故障转移 + 异步超时控制

#### 1. 添加严格的超时控制 (`src/react_agent/tools.py:35-52`)
```python
# 为每个MCP服务器配置添加严格超时设置
{
    "name": "twitter",
    "config": {
        "url": "http://103.149.46.64:8000/protocol/mcp/",
        "transport": "streamable_http",
        "timeout": httpx.Timeout(connect=3.0, read=5.0, write=5.0, pool=5.0)
    },
}
```

#### 2. 实现异步超时包装器
- 使用`asyncio.wait_for()`为整个`_get_all_mcp_tools()`函数添加10秒总超时
- 为每个服务器连接添加3秒单独超时
- 实现快速失败机制

#### 3. 优化工具加载策略
- **延迟加载**：首次调用时才初始化MCP工具，而非启动时
- **缓存机制**：成功加载的工具进行缓存，避免重复连接
- **降级模式**：MCP工具失败时，确保Tavily搜索仍可用

#### 4. 增强错误处理和监控
- 添加连接状态监控日志
- 为每种异常类型提供具体的处理逻辑
- 实现工具健康检查机制

#### 5. 代码修改点
1. `tools.py:30-99` - `_get_all_mcp_tools()`函数重构
2. `tools.py:117-285` - 所有Twitter工具函数添加缓存和超时
3. 新增：工具健康检查功能
4. 新增：工具加载状态缓存

## Tests

### 功能测试
- [ ] **工具初始化测试**：`debug_mcp_tools.py`脚本在10秒内完成执行
- [ ] **降级模式测试**：MCP服务不可用时，Tavily搜索功能正常工作
- [ ] **Studio UI响应测试**：用户输入消息后30秒内得到响应
- [ ] **Twitter工具测试**：MCP服务可用时，Twitter操作功能正常

### 性能测试
- [ ] 工具初始化总时间 < 10秒
- [ ] 单个MCP服务器连接超时 < 5秒
- [ ] 用户消息响应时间 < 30秒

### 边界测试
- [ ] 网络断开时的处理
- [ ] MCP服务器返回错误时的处理
- [ ] 并发请求时的工具共享机制